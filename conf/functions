#!/bin/sh

IPTABLES="/sbin/iptables"
IFCONFIG="/sbin/ifconfig"
ARPCHECK=$RUN_D/chilli.arp
LKFILE=$RUN_D/chilli.run
MAIN_CONF=/etc/chilli/main.conf
LOCAL_CONF=/etc/chilli/local.conf
HS_CONF=/etc/chilli/hs.conf
HS_TEMP=/tmp/hs.conf
RUN_D=/var/run
CMDSOCK=$RUN_D/chilli.sock
PIDFILE=$RUN_D/chilli.pid

[ -f /etc/chilli/defaults ] \
    && . /etc/chilli/defaults

[ -f /etc/sysconfig/chilli ] \
    && . /etc/sysconfig/chilli

HS_UAMPORT=${HS_UAMPORT:-3990}
HS_RADIUS=${HS_RADIUS:-$HS_UAMSERVER}
HS_RADSECRET=${HS_RADSECRET:-$HS_UAMSECRET}
HS_RADAUTH=${HS_RADAUTH:-1812}
HS_RADACCT=${HS_RADACCT=1813}
HS_ADMUSR=${HS_ADMUSR:-chillispot}
HS_ADMPWD=${HS_ADMPWD:-chillispot}
HS_ADMINTERVAL=${HS_ADMINTERVAL:-60}

bailout() { echo $1; exit; }

check_required() {
    [ -z "$HS_MODE" ]  && bailout "HS_MODE is required"
    [ -z "$HS_NASID" ] && bailout "HS_NASID is required"
    [ -z "$HS_UAMSERVER" -o -z "$HS_UAMSECRET" ] && bailout "HS_UAMSERVER and HS_UAMSECRET are required"
    [ -z "$HS_NETWORK"   -o -z "$HS_NETMASK"   ] && bailout "HS_NETWORK and HS_NETMASK are required"
    [ -z "$HS_UAMLISTEN" ] && bailout "HS_UAMLISTEN is required"
}
    
configs=
addconfig() { 
[ -n "$*" ] && \
configs="$configs
$*"
}

writeconfig() {
    addconfig ${HS_DYNIP:+"dynip $HS_DYNIP/${HS_DYNIP_MASK:-255.255.255.0}"}
    addconfig ${HS_STATIP:+"statip $HS_STATIP/${HS_STATIP_MASK:-255.255.255.0}"}
    addconfig ${HS_WWWDIR:+"wwwdir $HS_WWWDIR"}
    addconfig ${HS_UAMHOMEPAGE:+"uamhomepage $(eval echo $HS_UAMHOMEPAGE)"}
    addconfig ${HS_SSID:+"ssid $HS_SSID"}
    addconfig ${HS_NASIP:+"nasip $HS_NASIP"}
    addconfig ${HS_NASMAC:+"nasmac $HS_NASMAC"}
    addconfig ${HS_DNS_DOMAIN:+"domain $HS_DNS_DOMAIN"}
    addconfig ${HS_DNS1:+"dns1 $HS_DNS1"}
    addconfig ${HS_DNS2:+"dns2 $HS_DNS2"}

    HS_MACALLOW=$(echo $HS_MACALLOW|sed 's/ /,/g')
    HS_MACALLOW=$(echo $HS_MACALLOW|sed 's/[:-]//g')
    addconfig ${HS_MACALLOW:+"macallowed $HS_MACALLOW"}

    HS_UAMALLOW=$(echo $HS_UAMALLOW|sed 's/ /,/g')
    uamallow=${HS_UAMALLOW:+",$HS_UAMALLOW"}

    [ "$HS_WEB_ADMIN" = "on" ] && webadmin=",$HS_UAMLISTEN"
    [ "$HS_MACAUTH" = "on" ] && addconfig "macauth"

    (cat <<EOF
# THIS FILE IS AUTOMATICALLY GENERATED
cmdsocket       $CMDSOCK
pidfile         $PIDFILE
net		$HS_NETWORK/$HS_NETMASK
uamlisten	$HS_UAMLISTEN
uamport         $HS_UAMPORT
dhcpif		$HS_TAPIF
radiusserver1	$HS_RADIUS
radiusserver2	$HS_UAMSERVER
radiussecret	$HS_RADSECRET
radiusauthport  $HS_RADAUTH
radiusacctport  $HS_RADACCT
uamserver	$(eval echo $HS_UAMFORMAT)
uamallowed	coova.org,$HS_UAMSERVER,$HS_RADIUS$webadmin$uamallow
radiusnasid	$HS_NASID
uamsecret	$HS_UAMSECRET
adminuser       $HS_ADMUSR
adminpasswd     $HS_ADMPWD
uamanydns
$configs
EOF
) > $MAIN_CONF 
}

radiusconfig() {
    touch $LOCAL_CONF $HS_CONF 
    chilli_radconfig > $HS_TEMP
    if [ -x /usr/bin/cmp ]; then
	cmp -s $HS_TEMP $HS_CONF || (
	    mv $HS_TEMP $HS_CONF
	    killall -HUP chilli 2>&- >&-
	)
    else
        # no diff, so lets copy and let chilli
        # refresh on its own (interval option)
	mv $HS_TEMP $HS_CONF
    fi
}

